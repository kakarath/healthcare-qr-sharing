<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Portal - Healthcare QR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #2c5aa0; margin-bottom: 30px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; }
        .btn-primary { background: #007AFF; color: white; }
        .btn-success { background: #34C759; color: white; }
        .btn-warning { background: #FF9500; color: white; }
        .status { padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: 500; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .patient-data { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .data-item { margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; }
        .hidden { display: none; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-size: 16px; }
        textarea { height: 100px; resize: vertical; }
        .camera-container { text-align: center; margin: 20px 0; }
        video { width: 100%; max-width: 300px; border-radius: 8px; }
        .scan-area { position: relative; display: inline-block; }
        .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px solid #007AFF; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äç‚öïÔ∏è Provider Portal</h1>
            <p>Healthcare QR Scanner</p>
        </div>

        <div id="loginCard" class="card">
            <h2>Provider Login</h2>
            <input type="email" id="email" placeholder="Email" value="provider@hospital.com">
            <input type="password" id="password" placeholder="Password" value="provider123">
            <button class="btn btn-primary" onclick="login()">Login</button>
        </div>

        <div id="scannerCard" class="card hidden">
            <h3>Scan Patient QR Code</h3>
            
            <div class="camera-container">
                <div class="scan-area">
                    <video id="video" autoplay playsinline></video>
                    <div class="scan-overlay"></div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="startCamera()">Start Camera</button>
            <button class="btn btn-warning" onclick="stopCamera()">Stop Camera</button>
            
            <h4>Or Enter QR Data Manually:</h4>
            <textarea id="qrData" placeholder="Paste QR code data here..."></textarea>
            <button class="btn btn-primary" onclick="processQRData()">Process QR Data</button>
            
            <div id="patientDataResult" class="hidden">
                <h3>Patient Information</h3>
                <div id="patientDataContent" class="patient-data"></div>
            </div>
            
            <div id="status"></div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let video = null;
        let stream = null;

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.sessionId) {
                    sessionId = data.sessionId;
                    document.getElementById('loginCard').classList.add('hidden');
                    document.getElementById('scannerCard').classList.remove('hidden');
                    showStatus('Login successful! Ready to scan QR codes.');
                } else {
                    showStatus('Login failed. Please check your credentials.', 'error');
                }
            } catch (error) {
                showStatus('Login error: ' + error.message, 'error');
            }
        }

        async function startCamera() {
            try {
                video = document.getElementById('video');
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                video.srcObject = stream;
                showStatus('Camera started. Position QR code in the frame.');
                
                // Start QR detection (simplified - in real app use a QR library)
                setTimeout(() => {
                    showStatus('QR scanning active. Tap "Process QR Data" when ready.', 'success');
                }, 2000);
                
            } catch (error) {
                showStatus('Camera access denied or not available: ' + error.message, 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                showStatus('Camera stopped.');
            }
        }

        async function processQRData() {
            if (!sessionId) {
                showStatus('Please login first', 'error');
                return;
            }

            let qrData = document.getElementById('qrData').value;
            
            // For demo purposes, use sample QR data if none provided
            if (!qrData) {
                qrData = JSON.stringify({
                    sessionId: "demo-session-123",
                    patientId: "patient-001",
                    dataTypes: ["DEMOGRAPHICS", "VITALS", "MEDICATIONS"],
                    timestamp: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 15*60*1000).toISOString()
                });
                showStatus('Using demo QR data for testing', 'success');
            }

            try {
                const response = await fetch('/api/qr/scan', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ qrData })
                });
                
                const data = await response.json();
                
                if (data.patientData) {
                    displayPatientData(data.patientData);
                    showStatus('Patient data retrieved successfully!');
                } else {
                    showStatus('Failed to retrieve patient data: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('QR scan error: ' + error.message, 'error');
            }
        }

        function displayPatientData(patientData) {
            const container = document.getElementById('patientDataContent');
            container.innerHTML = `
                <div class="data-item"><strong>Name:</strong> ${patientData.firstName} ${patientData.lastName}</div>
                <div class="data-item"><strong>Email:</strong> ${patientData.email}</div>
                <div class="data-item"><strong>Date of Birth:</strong> ${patientData.dateOfBirth || 'Not provided'}</div>
                <div class="data-item"><strong>Blood Type:</strong> ${patientData.bloodType || 'O+'}</div>
                <div class="data-item"><strong>Allergies:</strong> ${patientData.allergies?.join(', ') || 'None known'}</div>
                <div class="data-item"><strong>Medications:</strong> ${patientData.medications?.join(', ') || 'None'}</div>
                <div class="data-item"><strong>Conditions:</strong> ${patientData.conditions?.join(', ') || 'None'}</div>
            `;
            document.getElementById('patientDataResult').classList.remove('hidden');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>